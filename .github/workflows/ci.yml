name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'
        cache: true
          
    - name: Download dependencies
      run: go mod download
      
    - name: Verify dependencies
      run: go mod verify
      
    - name: Run go vet
      run: go vet ./...
      
    - name: Run go fmt check
      run: |
        if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
          echo "Code is not formatted properly:"
          gofmt -s -l .
          exit 1
        fi
        
    - name: Run unit tests
      run: make test-unit
      
    - name: Run unit tests with coverage
      run: make test-coverage
      
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.out
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  build:
    runs-on: ubuntu-latest
    needs: test
    
    strategy:
      matrix:
        # Build for multiple platforms
        goos: [linux, windows, darwin]
        goarch: [amd64, arm64]
        exclude:
          # Exclude combinations that don't make sense
          - goos: windows
            goarch: arm64
            
    steps:
    - uses: actions/checkout@v5
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'
        cache: true

    - name: Build binary
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
      run: |
        mkdir -p dist
        if [ "$GOOS" = "windows" ]; then
          go build -ldflags="-s -w" -o dist/terraform-provider-pihole_${{ matrix.goos }}_${{ matrix.goarch }}.exe
        else
          go build -ldflags="-s -w" -o dist/terraform-provider-pihole_${{ matrix.goos }}_${{ matrix.goarch }}
        fi
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v6
      with:
        name: terraform-provider-pihole-${{ matrix.goos }}-${{ matrix.goarch }}
        path: dist/

  acceptance-test:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'run-acceptance-tests'))
    
    steps:
    - uses: actions/checkout@v5
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'
        cache: true

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Start Pi-hole container
      run: |
        docker run -d \
          --name pihole-test \
          -p 8080:80 \
          -p 8053:53/tcp \
          -p 8053:53/udp \
          -e FTLCONF_webserver_api_password=testpass123 \
          -e FTLCONF_webserver_api_max_sessions=200 \
          -e VIRTUAL_HOST=localhost \
          -e ServerIP=127.0.0.1 \
          -e DNS1=8.8.8.8 \
          -e DNS2=8.8.4.4 \
          pihole/pihole:2025.07.1

    - name: Wait for Pi-hole API readiness
      run: |
        echo "Waiting for Pi-hole v6 API to become ready..."
        timeout 180 bash -c '
          until curl -sf -X POST http://localhost:8080/api/auth \
            -H "Content-Type: application/json" \
            -d "{\"password\":\"testpass123\"}" | grep -q "\"valid\":true"; do
            echo "  API not ready yet, retrying in 5s..."
            sleep 5
          done
        '
        echo "Pi-hole API is ready."
        
    - name: Run acceptance tests
      env:
        TF_ACC: 1
        PIHOLE_URL: http://localhost:8080
        PIHOLE_PASSWORD: testpass123
      run: make test-acc
      
    - name: Stop Pi-hole container
      if: always()
      run: docker stop pihole-test && docker rm pihole-test

  lint:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v5
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'
        cache: true

    - name: Run golangci-lint
      uses: golangci/golangci-lint-action@v6
      with:
        version: v2.9.0
        args: --timeout=5m