name: Commit Lint

on:
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read

jobs:
  commitlint:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v5
      with:
        fetch-depth: 0

    - name: Validate PR commit messages
      run: |
        # Check all commits in the PR for conventional commit format
        COMMITS=$(git log --format="%s" origin/${{ github.base_ref }}..HEAD)
        PATTERN="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert|deps)(\(.+\))?!?: .+"
        FAILED=0

        while IFS= read -r msg; do
          if [ -z "$msg" ]; then
            continue
          fi
          if ! echo "$msg" | grep -qE "$PATTERN"; then
            echo "FAIL: $msg"
            FAILED=1
          else
            echo "  OK: $msg"
          fi
        done <<< "$COMMITS"

        if [ "$FAILED" -eq 1 ]; then
          echo ""
          echo "Commit messages must follow Conventional Commits format:"
          echo "  <type>(<optional scope>): <description>"
          echo ""
          echo "Allowed types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert, deps"
          exit 1
        fi

        echo "All commit messages follow conventional commit format."
